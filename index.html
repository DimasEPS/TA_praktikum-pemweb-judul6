<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weather Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              display: ['"Poppins"', "ui-sans-serif", "system-ui"],
            },
          },
        },
      };
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />
  </head>
  <body
    class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-display min-h-screen transition-colors"
  >
    <div class="max-w-6xl mx-auto px-6 py-8 space-y-6">
      <header class="bg-white dark:bg-gray-800 rounded-lg shadow p-5">
        <div
          class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
        >
          <div>
            <h1 class="text-3xl font-bold text-teal-600 dark:text-teal-400">
              Weather Dashboard
            </h1>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
              Realtime cuaca & prakiraan 5 hari
            </p>
          </div>
          <div class="flex gap-2">
            <button
              id="themeToggle"
              class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition"
            >
              Theme
            </button>
            <button
              id="unitToggle"
              class="px-4 py-2 rounded-lg bg-teal-600 text-white hover:bg-teal-700 transition"
            >
              ¬∞C / ¬∞F
            </button>
            <button
              id="refreshBtn"
              class="px-4 py-2 rounded-lg bg-cyan-600 text-white hover:bg-cyan-700 transition"
            >
              Refresh
            </button>
          </div>
        </div>
      </header>

      <section
        class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 space-y-3"
      >
        <div class="relative">
          <input
            id="searchInput"
            type="text"
            placeholder="Cari kota..."
            class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-teal-500 text-gray-900 dark:text-gray-100"
            autocomplete="off"
          />
          <div
            id="suggestions"
            class="absolute z-10 mt-1 w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg hidden"
          ></div>
        </div>
        <button
          id="addFavorite"
          class="px-4 py-2 rounded-lg bg-teal-100 dark:bg-teal-900/50 text-teal-700 dark:text-teal-300 hover:bg-teal-200 dark:hover:bg-teal-900/70 transition"
        >
          Tambah Favorit
        </button>
        <div class="flex flex-wrap gap-2" id="favorites"></div>
      </section>

      <section class="grid gap-5 lg:grid-cols-3">
        <div class="lg:col-span-1">
          <div class="p-6 rounded-lg bg-teal-600 text-white shadow-lg relative">
            <div
              id="loadingCurrent"
              class="absolute inset-0 bg-black/20 hidden items-center justify-center"
            >
              <div
                class="h-10 w-10 border-4 border-white/30 border-t-white rounded-full animate-spin"
              ></div>
            </div>
            <div class="flex items-center justify-between mb-5">
              <div>
                <p class="text-xs uppercase text-white/70">Saat Ini</p>
                <h2 id="location" class="text-xl font-bold mt-1">-</h2>
                <p id="timestamp" class="text-xs text-white/70 mt-1">-</p>
              </div>
              <div id="currentIcon" class="text-5xl">‚òÅÔ∏è</div>
            </div>
            <div class="mb-5">
              <div class="text-5xl font-bold" id="temperature">-</div>
              <p id="condition" class="text-lg mt-1">-</p>
            </div>
            <div
              class="grid grid-cols-3 gap-3 pt-4 border-t border-white/20 text-sm"
            >
              <div>
                <p class="text-xs text-white/70">Humidity</p>
                <p id="humidity" class="text-lg font-bold">-</p>
              </div>
              <div>
                <p class="text-xs text-white/70">Wind</p>
                <p id="wind" class="text-lg font-bold">-</p>
              </div>
              <div>
                <p class="text-xs text-white/70">Feels</p>
                <p id="feelslike" class="text-lg font-bold">-</p>
              </div>
            </div>
          </div>
        </div>
        <div class="lg:col-span-2">
          <div class="p-5 bg-white dark:bg-gray-800 rounded-lg shadow">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold text-teal-600 dark:text-teal-400">
                Prakiraan 5 Hari
              </h3>
              <div
                id="loadingForecast"
                class="flex items-center gap-2 text-sm text-gray-500 hidden"
              >
                <div
                  class="h-4 w-4 border-2 border-teal-500 border-t-transparent rounded-full animate-spin"
                ></div>
                Loading...
              </div>
            </div>
            <div
              id="forecast"
              class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4"
            ></div>
          </div>
        </div>
      </section>
    </div>

    <script>
      const DEFAULT_LOCATION = {
        name: "Jakarta",
        country: "Indonesia",
        latitude: -6.2,
        longitude: 106.8167,
      };
      const UPDATE_INTERVAL = 300000; // 5 minutes

      const elements = {
        location: document.getElementById("location"),
        timestamp: document.getElementById("timestamp"),
        temperature: document.getElementById("temperature"),
        condition: document.getElementById("condition"),
        humidity: document.getElementById("humidity"),
        wind: document.getElementById("wind"),
        feelslike: document.getElementById("feelslike"),
        currentIcon: document.getElementById("currentIcon"),
        forecast: document.getElementById("forecast"),
        loadingCurrent: document.getElementById("loadingCurrent"),
        loadingForecast: document.getElementById("loadingForecast"),
        searchInput: document.getElementById("searchInput"),
        suggestions: document.getElementById("suggestions"),
        favorites: document.getElementById("favorites"),
        addFavorite: document.getElementById("addFavorite"),
        unitToggle: document.getElementById("unitToggle"),
        themeToggle: document.getElementById("themeToggle"),
        refreshBtn: document.getElementById("refreshBtn"),
      };

      let currentLocation = loadLastLocation() || DEFAULT_LOCATION;
      let unit = localStorage.getItem("unit") || "c";
      let theme = localStorage.getItem("theme") || "light";
      let updateTimer = null;
      const lastData = { current: null, forecast: null };
      let lastSuggestions = [];

      const weatherCodeMap = {
        0: "Cerah",
        1: "Sebagian berawan",
        2: "Berawan",
        3: "Mendung",
        45: "Berkabut",
        48: "Kabut beku",
        51: "Gerimis ringan",
        53: "Gerimis",
        55: "Gerimis lebat",
        56: "Gerimis beku",
        57: "Gerimis beku lebat",
        61: "Hujan ringan",
        63: "Hujan",
        65: "Hujan lebat",
        66: "Hujan beku",
        67: "Hujan beku lebat",
        71: "Salju ringan",
        73: "Salju",
        75: "Salju lebat",
        77: "Kristal salju",
        80: "Hujan deras singkat",
        81: "Hujan sangat deras",
        82: "Badai hujan",
        85: "Hujan salju",
        86: "Hujan salju lebat",
        95: "Badai petir",
        96: "Badai petir dengan butiran es",
        99: "Badai petir es berat",
      };

      const iconMap = {
        0: "‚òÄÔ∏è",
        1: "üå§Ô∏è",
        2: "‚õÖ",
        3: "‚òÅÔ∏è",
        45: "üå´Ô∏è",
        48: "üå´Ô∏è",
        51: "üå¶Ô∏è",
        53: "üå¶Ô∏è",
        55: "üåßÔ∏è",
        56: "üåßÔ∏è",
        57: "üåßÔ∏è",
        61: "üåßÔ∏è",
        63: "üåßÔ∏è",
        65: "üåßÔ∏è",
        66: "üåßÔ∏è",
        67: "üåßÔ∏è",
        71: "üå®Ô∏è",
        73: "üå®Ô∏è",
        75: "‚ùÑÔ∏è",
        77: "‚ùÑÔ∏è",
        80: "üåßÔ∏è",
        81: "üåßÔ∏è",
        82: "üåßÔ∏è",
        85: "üå®Ô∏è",
        86: "üå®Ô∏è",
        95: "‚õàÔ∏è",
        96: "‚õàÔ∏è",
        99: "‚õàÔ∏è",
      };

      function setTheme(nextTheme) {
        theme = nextTheme;
        document.documentElement.classList.toggle("dark", theme === "dark");
        localStorage.setItem("theme", theme);
      }

      function setUnit(nextUnit) {
        unit = nextUnit;
        localStorage.setItem("unit", unit);
        renderLastData();
      }

      function cToF(c) {
        return c * 1.8 + 32;
      }

      function kmhToMph(speed) {
        return speed / 1.60934;
      }

      function formatTemp(celsius) {
        return unit === "c"
          ? `${Math.round(celsius)}¬∞C`
          : `${Math.round(cToF(celsius))}¬∞F`;
      }

      function formatWind(speedKmh) {
        return unit === "c"
          ? `${speedKmh.toFixed(1)} km/h`
          : `${kmhToMph(speedKmh).toFixed(1)} mph`;
      }

      function getConditionText(code) {
        return weatherCodeMap[code] || "Cuaca tidak diketahui";
      }

      function getIcon(code) {
        return iconMap[code] || "‚òÅÔ∏è";
      }

      function renderCurrent(data, locationMeta) {
        const { current } = data;
        elements.location.textContent = `${locationMeta.name}, ${locationMeta.country}`;
        elements.timestamp.textContent = new Date(
          current.time
        ).toLocaleString();
        elements.temperature.textContent = formatTemp(current.temperature_2m);
        elements.condition.textContent = getConditionText(current.weather_code);
        elements.humidity.textContent = `${current.relative_humidity_2m}%`;
        elements.wind.textContent = formatWind(current.wind_speed_10m);
        elements.feelslike.textContent = formatTemp(
          current.apparent_temperature
        );
        elements.currentIcon.textContent = getIcon(current.weather_code);
        elements.currentIcon.setAttribute(
          "aria-label",
          getConditionText(current.weather_code)
        );
        lastData.current = { ...data, location: locationMeta };
      }

      function renderForecast(forecast, locationMeta) {
        lastData.forecast = { forecast, location: locationMeta };
        const { time, temperature_2m_min, temperature_2m_max, weather_code } =
          forecast.daily;
        elements.forecast.innerHTML = time
          .slice(0, 5)
          .map((date, idx) => {
            const label = new Date(date).toLocaleDateString(undefined, {
              weekday: "short",
              day: "numeric",
            });
            const min = formatTemp(temperature_2m_min[idx]);
            const max = formatTemp(temperature_2m_max[idx]);
            const code = weather_code[idx];
            return `
              <div class="p-4 rounded-lg bg-gray-50 dark:bg-gray-700">
                <p class="text-sm font-bold text-teal-600 dark:text-teal-400">${label}</p>
                <div class="text-4xl text-center my-2">${getIcon(code)}</div>
                <p class="text-sm font-semibold text-center mb-2">${getConditionText(
                  code
                )}</p>
                <div class="flex justify-between text-xs">
                  <span class="text-blue-600 dark:text-blue-400">Min: ${min}</span>
                  <span class="text-red-600 dark:text-red-400">Max: ${max}</span>
                </div>
              </div>
            `;
          })
          .join("");
      }

      function toggleLoading(show) {
        elements.loadingCurrent.classList.toggle("hidden", !show);
        elements.loadingCurrent.classList.toggle("flex", show);
        elements.loadingForecast.classList.toggle("hidden", !show);
      }

      async function fetchWeather(location) {
        if (!location?.latitude || !location?.longitude) {
          alert("Lokasi tidak valid.");
          return;
        }
        toggleLoading(true);
        try {
          const url = `https://api.open-meteo.com/v1/forecast?latitude=${location.latitude}&longitude=${location.longitude}&current=temperature_2m,relative_humidity_2m,wind_speed_10m,apparent_temperature,weather_code&daily=temperature_2m_max,temperature_2m_min,weather_code&forecast_days=5&timezone=auto`;
          const resp = await fetch(url);
          if (!resp.ok) throw new Error("Gagal mengambil data");
          const data = await resp.json();
          renderCurrent(data, location);
          renderForecast(data, location);
          currentLocation = location;
          elements.searchInput.value = "";
          saveLastLocation(location);
        } catch (err) {
          console.error(err);
          alert("Tidak bisa memuat cuaca. Periksa nama kota dan koneksi.");
        } finally {
          toggleLoading(false);
          resetAutoUpdate();
        }
      }

      async function fetchSuggestions(query) {
        if (!query) return [];
        try {
          const resp = await fetch(
            `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(
              query
            )}&count=5&language=id`
          );
          if (!resp.ok) return [];
          const data = await resp.json();
          return data.results
            ? data.results.map((item) => ({
                name: item.name,
                country: item.country,
                latitude: item.latitude,
                longitude: item.longitude,
              }))
            : [];
        } catch (err) {
          console.error(err);
          return [];
        }
      }

      function saveFavorites(favs) {
        localStorage.setItem("favorites", JSON.stringify(favs));
        renderFavorites();
      }

      function getFavorites() {
        const favs = localStorage.getItem("favorites");
        return favs ? JSON.parse(favs) : [];
      }

      function saveLastLocation(location) {
        localStorage.setItem("lastLocation", JSON.stringify(location));
      }

      function loadLastLocation() {
        const loc = localStorage.getItem("lastLocation");
        return loc ? JSON.parse(loc) : null;
      }

      function renderFavorites() {
        const favs = getFavorites();
        elements.favorites.innerHTML = favs.length
          ? favs
              .map(
                (loc, idx) => `
          <span class="inline-flex gap-1">
            <button data-idx="${idx}" class="px-3 py-1.5 rounded-lg bg-teal-100 dark:bg-teal-900/50 text-teal-700 dark:text-teal-300 text-sm hover:bg-teal-200 dark:hover:bg-teal-900/70">
              ${loc.name}
            </button>
            <button data-remove="${idx}" class="px-2 py-1.5 rounded-lg bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-900/50">√ó</button>
          </span>
        `
              )
              .join("")
          : '<p class="text-sm text-gray-500 dark:text-gray-400">Belum ada favorit</p>';
      }

      function renderSuggestions(list) {
        lastSuggestions = list;
        if (!list.length) {
          elements.suggestions.classList.add("hidden");
          return;
        }
        elements.suggestions.innerHTML = list
          .map(
            (item, idx) => `
        <button data-idx="${idx}" class="w-full text-left px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm">${item.name}, ${item.country}</button>
      `
          )
          .join("");
        elements.suggestions.classList.remove("hidden");
      }

      function renderLastData() {
        if (lastData.current)
          renderCurrent(lastData.current, lastData.current.location);
        if (lastData.forecast)
          renderForecast(
            lastData.forecast.forecast,
            lastData.forecast.location
          );
      }

      function resetAutoUpdate() {
        if (updateTimer) clearInterval(updateTimer);
        updateTimer = setInterval(
          () => fetchWeather(currentLocation),
          UPDATE_INTERVAL
        );
      }

      elements.searchInput.addEventListener("input", async (e) => {
        const q = e.target.value.trim();
        const suggestions = await fetchSuggestions(q);
        renderSuggestions(suggestions);
      });

      elements.suggestions.addEventListener("click", (e) => {
        const idx = e.target.getAttribute("data-idx");
        if (idx !== null) {
          const picked = lastSuggestions[Number(idx)];
          if (picked) {
            elements.suggestions.classList.add("hidden");
            fetchWeather(picked);
          }
        }
      });

      async function handleManualSearch(cityName) {
        const list = await fetchSuggestions(cityName);
        if (list[0]) {
          fetchWeather(list[0]);
        } else {
          alert("Kota tidak ditemukan.");
        }
      }

      elements.searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          const city = e.target.value.trim();
          if (city) handleManualSearch(city);
        }
      });

      elements.favorites.addEventListener("click", (e) => {
        const idx = e.target.getAttribute("data-idx");
        const remove = e.target.getAttribute("data-remove");
        const favs = getFavorites();
        if (remove !== null) {
          favs.splice(Number(remove), 1);
          saveFavorites(favs);
          return;
        }
        if (idx !== null) {
          const loc = favs[Number(idx)];
          if (loc) fetchWeather(loc);
        }
      });

      elements.unitToggle.addEventListener("click", () => {
        setUnit(unit === "c" ? "f" : "c");
      });

      elements.themeToggle.addEventListener("click", () => {
        setTheme(theme === "dark" ? "light" : "dark");
      });

      elements.refreshBtn.addEventListener("click", () =>
        fetchWeather(currentLocation)
      );

      elements.addFavorite.addEventListener("click", () => {
        const favs = getFavorites();
        const exists = favs.some(
          (loc) =>
            loc.name === currentLocation.name &&
            loc.latitude === currentLocation.latitude &&
            loc.longitude === currentLocation.longitude
        );
        if (!exists) saveFavorites([...favs, currentLocation]);
      });

      // Initial setup
      setTheme(theme);
      setUnit(unit);
      renderFavorites();
      fetchWeather(currentLocation);
    </script>
  </body>
</html>
